<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Companies</title>
        <link rel="icon" type="image/x-icon" href="./images/favicon.png">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="styles/styles.css">
        <link rel="stylesheet" href="styles/companies.css">
        <script>
            $(document).ready(function () {
                //get url params : id
                $('.postalCodeWarning').hide();
                $('.nameWarning').hide();
                const queryString = window.location.search;
 
                const urlParams = new URLSearchParams(queryString);
                const id = urlParams.get('id')
    //console.log(`id = ${id}`);
                if(id == 0 ){
                    $("#addnew").text("Add New");
                }else{
                    $("#addnew").text("Update");
                     getCompany(id);
                    
                }
                $("#addnew").on("click", function(){
                    //if(!validateData()) return false;
                    if($("#addnew").text() === "Update"){
                        updateCpmpany(id);
                    }else{
                        addNew();
                    }
                    
                });
                $("#modalclose").on("click",function(){
                    console.log("modalclose clicked, return to index");
                    window.open('index.html', '_self');
                });
                $('.postalCodeWarning').hide();
                $('.nameWarning').hide();
            });

            //update company
            function updateCpmpany(id) {
                const name = $("#companyname").val();  
                console.log("name= "+ name );
                if (name == null || name ==""){
                    $(".nameWarning").show();
                    return false;
                } 
                const desc = $("#desc").val();
                const industry = $("#industry").val();

                const streetno = $("#streetno").val();                    
                const street = $("#street").val();
                const city = $("#city").val();

                const province = $("#province").val();
                const postcode = $("#postcode").val();

                const currentdate = new Date();
                const createdate = currentdate.toLocaleString();
                var company = {
                    name : name,
                    description : desc,
                    industry : industry,
                    streetno : streetno,
                    street : street,
                    city : city,
                    province : province,
                    postcode : postcode,
                    ceate_date : createdate,
                };

                $.ajax({
                    url:"/api/companies/"+id,
                    type:"put",
                    dataType:"json",
                    data:company,
                    error: function (jqxhr, status, errorThrown) {
                    alert("AJAX error: " + jqxhr.responseText);
                    }
                }).done(function(company){
                    $("#addsuccess").modal("show");
                });
            }

            //add new company
            function addNew() {
                const name = $("#companyname").val();     
                console.log("name= "+ name );
                if (name == null || name ==""){
                    $(".nameWarning").show();
                    return false;
                }               
                    const desc = $("#desc").val();
                    const industry = $("#industry").val();

                    const streetno = $("#streetno").val();                    
                    const street = $("#street").val();
                    const city = $("#city").val();

                    const province = $("#province").val();
                    const postcode = $("#postcode").val();

                    const currentdate = new Date();
                    const createdate = currentdate.toLocaleString();
                    var company = {
                        name : name,
                        description : desc,
                        industry : industry,
                        streetno : streetno,
                        street : street,
                        city : city,
                        province : province,
                        postcode : postcode,
                        ceate_date : createdate,
                    };

                    $.ajax({
                        url:"/api/companies/",
                        type:"post",
                        dataType:"json",
                        data:company,
                        error: function (jqxhr, status, errorThrown) {
                        alert("AJAX error: " + jqxhr.responseText);
                        }
                    }).done(function(company){
                        $("#addsuccess").modal("show");
                    });
            }
            //get company
            function getCompany(id) {
                console.log("/api/Companies/"+id);
                $.ajax({
                    url:"/api/Companies/"+id,
                    type:"GET",
                    dataType:"json",
                    error: function (jqxhr, status, errorThrown) {
                        alert("AJAX error: " + jqxhr.responseText);
                        }
                }).done(function(company){
                    $("#companyname").val(company.name);
                    $("#desc").val(company.description);
                    $("#industry").val(company.industry);
                    $("#streetno").val(company.streetno);
                    $("#street").val(company.street);
                    $("#city").val(company.city);
                    $("#province").val(company.province);
                    $("#postcode").val(company.postcode);
                });
            }

            function validateData() {
                console.log("postalCode= " + $("#postcode").val());
                //validat postcode
                const postalCode = $("#postcode").val();
                const PosteCodeRegex = /^[A-Za-z]\d[A-Za-z]?\d[A-Za-z]\d$/;
                if (postalCode !== null || postalCode !==""){
                    if( !PosteCodeRegex.test(postalCode)){
                        $('.postalCodeWarning').show();
                        return false;
                    };
                }
            }
        </script>
    </head>
    <body>

        <header>
            <div>
                <img src="/images/logo_transparent.png" alt="Logo">
                <nav>
                    <ul>
                        <li><a href="#">Job Listings</a></li>
                        <li><a href="#">Job Seekers</a></li>
                        <li><a href="#">Employers</a></li>
                    </ul>
                </nav>
            </div>
        </header>
    
        <!-- Modal -->
        <div class="modal fade" id="addsuccess" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Congratulations</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                      </div>
                    <div class="modal-body">
                        <p>Think you, your company is added.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="modalclose" class="btn btn-primary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="listedContent">
            <div id="listPane">
                    <div>
                        <label for="companyname">Company Name: </label>
                        <input type="text" id = "companyname" required>
                        <p class="nameWarning" style="color: red;">Not a valid company name</p>
                    </div>
                        <label for="desc">Description: </label>
                        <textarea id = "desc" ></textarea>

                    <div>
                    <label for="industry">Industry: </label>
                        <select id="industry">
                            <option value="Finance">Finance</option>
                            <option value="Chemical">Chemical</option>
                            <option value="Agriculture">Agriculture</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Jewelry">Jewelry</option>
                            <option value="Publishing">Publishing</option>
                            <option value="Technology">Technology</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Education">Education</option>
                            <option value="Hospitality">Hospitality</option>
                        </select>
                    </div>
                    <div>
                        <label for="streetno">Street No: </label>
                        <input type="text" id = "streetno" >
                        <p class="streetnowarn"></p>
                    </div>
                    <div>
                        <label for="street">Street: </label>
                        <input type="text" id = "street" >
                    </div>
                    <div>
                        <label for="city">City: </label>
                        <input type="text" id = "city" >
                    </div>
                    <div>
                        <label for="province">Province: </label>
                        <select id="province">
                            <option value="Alberta">Alberta</option>
                            <option value="British Columbia">British Columbia</option>
                            <option value="Manitoba">Manitoba</option>
                            <option value="New Brunswick">New Brunswick</option>
                            <option value="Newfoundland and Labrador">Newfoundland and Labrador</option>
                            <option value="Nova Scotia">Nova Scotia</option>
                            <option value="Ontario">Ontario</option>
                            <option value="Prince Edward Island">Prince Edward Island</option>
                            <option value="Quebec">Quebec</option>
                            <option value="Saskatchewa">Saskatchewa</option>
                        </select>
                    </div>
                    <div>
                        <label for="postcode">Postcode: </label>
                        <input type="text" id = "postcode" >
                        <p class="postalCodeWarning">Not a valid postal code</p>
                    </div>
                    <button id="addnew">Add</button>

            </div>
        </div>
        <footer>
            <div>
                <p>WorkRight &copy; 2023</p>
            </div>
        </footer>
    </body>
</html>