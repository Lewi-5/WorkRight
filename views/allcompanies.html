<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>All Companies</title>
        <link rel="icon" type="image/x-icon" href="./images/favicon.png">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="styles/companies.css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
        <script>
            var companyid = "";
            $(document).ready(function () {
                const selectedOption = $("#sortSelect").val();
                refreshTodoList(selectedOption);

                $('#addNewCompany').on("click", function(){
                    window.open('./companies.html?id=0', '_self');
                });

                $('#updateCompany').on("click", function(){
                    if(companyid == null || companyid == ""){
                        //alert("Please select company!");
                        //$("#warning").modal("show");
                        $("#popupMessage").dialog({
                            modal: true,
                            buttons: {
                                OK: function() {
                                    $(this).dialog("close");
                                }
                            }
                        });
                        
                    }else{
                        window.open('./companies.html?id='+companyid, '_self');
                    }
                });

                $('#deleteCompany').on("click", function(){
                    if(companyid == null || companyid == ""){
                        //alert("Please select company!");     //TODO change the pop pup
                        //$("#warning").modal("show");
                        $("#popupMessage").dialog({
                            modal: true,
                            buttons: {
                                OK: function() {
                                    $(this).dialog("close");
                                }
                            }
                        });
                    }else{
                        $("#deletepopupMessage").dialog({
                            modal: true,
                            buttons: {
                                Yes: function() {
                                    $.ajax({
                                        url:"/api/companies/"+companyid,
                                        type:"delete",
                                        dataType:"json",
                                        error: function (jqxhr, status, errorThrown) {
                                        alert("AJAX error: " + jqxhr.responseText);
                                    }
                                    }).done(function(company){
                                        refreshTodoList();
                                    });
                                    $(this).dialog("close");
                                },
                                Cancel: function() {
                                    $(this).dialog("close");
                                }
                            }
                        });
                        
                    }
                });

                $('#getJods').on("click", function(){
                    if(companyid == null || companyid == ""){
                        alert("Please select company!");
                        //$("#warning").modal("show");
                    }else{
                        window.open('./companyJobs.html?id='+companyid, '_blank');
                    }
                    //http://localhost:7077/companyJobs.html?id=29
                });

                $('#sortSelect').change(function() {
                    var selectedOption = $("#sortSelect").val();

                    // Perform sorting based on the selected option
                    refreshTodoList(selectedOption)

                });
            });
            //refreshTodoList
            function refreshTodoList(params) {
                const sortBy = params ? params : "id";
                $.ajax({
                    url:"/api/allcompanies?sortBy="+sortBy,
                    type:"GET",
                    dataType:"json",
                    error: function (jqxhr, status, errorThrown) {
                        alert("AJAX error: " + jqxhr.responseText);
                        }
                }).done(function(companiesList){
                    var result = '<tr><th>Name</th><th>Description</th><th>Industry</th><th>City</th><th>Create Date</th></tr>';
                    for (var i = 0; i < companiesList.length; i++) {
                        var company = companiesList[i];
                        console.log("company.createDate = " + company.createDate);
                        if(company.createDate){
                            var datetime = new Date(company.createDate);
                            var formattedDatetime = datetime.toLocaleString('en-US', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            });
                        }
                        result += `<tr id="${company.ID}"  onclick="selectItem(` + company.ID + `)">`;
                        result += '<td>' + company.name + '</td>';
                        result += '<td>' + company.description + '</td>';
                        result += '<td>' + company.industry + '</td>';
                        result += '<td>' + company.city + '</td>';
                        result += '<td>' + formattedDatetime + '</td>';
                        result += '</tr>' + "\n";
                    }
                    $("#listTable").html(result);
                });
            }
            //when click one row
            function selectItem(id) {
                companyid = id;
                //console.log("id = "+ id);
                //window.open('companies.html?id='+id, '_self');

                // Remove the 'selected-row' class from all rows
                $('tr').removeClass('selected-row');
                    
                // Add the 'selected-row' class to the clicked row
                $(`#${id}`).addClass('selected-row');
            }

        </script>
    </head>
    <body>

        <header>
            <div>
                <img src="/images/logo_transparent.png" alt="Logo">
                <nav>
                    <ul>
                        <li><a href="#">Job Listings</a></li>
                        <li><a href="#">Job Seekers</a></li>
                        <li><a href="#">Employers</a></li>
                    </ul>
                </nav>
            </div>
        </header>
        <div id="popupMessage" style="display: none;">
            <p>Please select a company by click on the record.</p>
        </div>
        <div id="deletepopupMessage" style="display: none;">
            <p>Are you sure you want to delete this company.</p>
        </div>

        <div id="centerContent">
            <div id="listPane">
                <button id="addNewCompany">Add New</button>
                <button id="updateCompany">Update company</button>
                <button id="deleteCompany">Delete company</button>
                <button id="getJods">View Jobs</button><br><br>
                <select id="sortSelect">
                    <option value="name">Sort by Company Name</option>
                    <option value="industry">Sort by industry</option>
                    <option value="createDate">Sort by create date</option>
                  </select>

                <table id="listTable" border="1"></table>
            </div>
            
        </div>

        <footer>
            <div>
                <p>WorkRight &copy; 2023</p>
            </div>
        </footer>
    </body>
</html>